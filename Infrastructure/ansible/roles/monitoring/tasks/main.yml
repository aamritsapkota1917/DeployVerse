# -----------------------------
# Prometheus directories & configs
# -----------------------------
- name: Create Prometheus directory
  file:
    path: /opt/prometheus
    state: directory

- name: Create rules directory
  file:
    path: /opt/prometheus/rules
    state: directory

- name: Copy container alert rules
  copy:
    src: container_rules.yml
    dest: /opt/prometheus/rules/container_rules.yml

- name: Copy Alertmanager config
  template:
    src: alertmanager.yml.j2
    dest: /opt/prometheus/alertmanager.yml
  no_log: true

- name: Copy Prometheus config
  template:
    src: prometheus.yml.j2
    dest: /opt/prometheus/prometheus.yml

# -----------------------------
# Docker network
# -----------------------------
- name: Create monitoring docker network
  docker_network:
    name: monitoring

# -----------------------------
# Prometheus container
# -----------------------------
- name: Start Prometheus container
  docker_container:
    name: prometheus
    image: prom/prometheus
    restart_policy: always
    networks:
      - name: monitoring
    etc_hosts:
      host.docker.internal: "host-gateway"
    ports:
      - "9090:9090"
    volumes:
      - /opt/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - /opt/prometheus/rules:/etc/prometheus/rules

# -----------------------------
# Alertmanager container
# -----------------------------
- name: Start Alertmanager
  docker_container:
    name: alertmanager
    image: prom/alertmanager
    restart_policy: always
    networks:
      - name: monitoring
    ports:
      - "9093:9093"
    volumes:
      - /opt/prometheus/alertmanager.yml:/etc/alertmanager/alertmanager.yml

# -----------------------------
# Node Exporter container
# -----------------------------
- name: Start Node Exporter
  docker_container:
    name: node-exporter
    image: prom/node-exporter
    restart_policy: always
    networks:
      - name: monitoring
    ports:
      - "9100:9100"

# -----------------------------
# Loki directories
# -----------------------------
- name: Create Loki directory
  file:
    path: /opt/loki
    state: directory
    recurse: true

# -----------------------------
# Promtail directories
# -----------------------------
- name: Create Promtail directory
  file:
    path: /opt/promtail
    state: directory
    recurse: true

# Copy Loki config
- name: Copy Loki config
  copy:
    src: loki-config.yml
    dest: /opt/loki/loki-config.yml

# Copy Promtail config
- name: Copy Promtail config
  copy:
    src: promtail-config.yml
    dest: /opt/promtail/promtail-config.yml

# -----------------------------
# Loki container
# -----------------------------
- name: Start Loki
  docker_container:
    name: loki
    image: grafana/loki:2.9.0
    restart_policy: always
    networks:
      - name: monitoring
    ports:
      - "3100:3100"
    volumes:
      - /opt/loki/loki-config.yml:/etc/loki/config.yml

# -----------------------------
# Promtail container
# -----------------------------
- name: Start Promtail
  docker_container:
    name: promtail
    image: grafana/promtail:2.9.0
    restart_policy: always
    networks:
      - name: monitoring
    ports:
      - "9080:9080"
    volumes:
      - /opt/promtail/promtail-config.yml:/etc/promtail/config.yml
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/log:/var/log:ro
    command: -config.file=/etc/promtail/config.yml

# -----------------------------
# Grafana directories for provisioning
# -----------------------------
- name: Create Grafana provisioning directories
  file:
    path: /opt/grafana/provisioning/datasources
    state: directory
    recurse: true

# -----------------------------
# Grafana dashboards provisioning
# -----------------------------

- name: Create Grafana dashboards provisioning directory
  file:
    path: /opt/grafana/provisioning/dashboards
    state: directory
    recurse: true

# -----------------------------
# copy Grafana dashboard JSON
# -----------------------------

- name: Copy Grafana dashboard JSON
  copy:
    src: my_dashboard.json
    dest: /opt/grafana/provisioning/dashboards/my_dashboard.json

# -----------------------------
# Grafana prometheus datasource config
# -----------------------------
- name: Copy Prometheus datasource config
  copy:
    src: prometheus-datasource.yml
    dest: /opt/grafana/provisioning/datasources/prometheus-datasource.yml

# -----------------------------
# Grafana Loki datasource config
# -----------------------------

- name: Copy Loki datasource config
  copy:
    src: loki-datasource.yml
    dest: /opt/grafana/provisioning/datasources/loki-datasource.yml

# -----------------------------
# Grafana dashboard provisioning config
# -----------------------------

- name: Copy Grafana dashboard provisioning config
  copy:
    dest: /opt/grafana/provisioning/dashboards/dashboard.yml
    content: |
      apiVersion: 1
      providers:
        - name: 'default'
          orgId: 1
          folder: ''
          type: file
          disableDeletion: false
          updateIntervalSeconds: 10
          options:
            path: /etc/grafana/provisioning/dashboards

# -----------------------------
# Grafana container
# -----------------------------
- name: Start Grafana
  docker_container:
    name: grafana
    image: grafana/grafana
    restart_policy: always
    networks:
      - name: monitoring
    ports:
      - "3000:3000"
    env:
      GF_SECURITY_ADMIN_PASSWORD: "{{ grafana_admin_password }}"
    volumes:
      - /opt/grafana/provisioning:/etc/grafana/provisioning
