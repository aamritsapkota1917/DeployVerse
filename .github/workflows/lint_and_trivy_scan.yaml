name: Lint and Trivy Report

permissions:
  contents: write
  pull-requests: write

on:
  pull_request:
    branches: ["Dev"]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          filters: |
            backend:
              - 'Backend/**'
            frontend:
              - 'Frontend/**'

  lint-and-scan-frontend:
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Install dependencies
        working-directory: Frontend
        run: npm install

      - name: Lint Frontend
        working-directory: Frontend
        run: npm run lint

      - name: Trivy Scan Frontend
        id: trivy-frontend
        uses: aquasecurity/trivy-action@0.30.0
        continue-on-error: true
        with:
          scan-type: "fs"
          scan-ref: "Frontend/"
          format: "table"
          scanners: "vuln,secret,misconfig"
          severity: "CRITICAL,HIGH"
          exit-code: 1
          output: "trivy-frontend-results.txt"

      - name: Upload Trivy Results as Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-frontend-scan
          path: trivy-frontend-results.txt

      - name: Comment Trivy Results on PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const trivyResults = fs.readFileSync('trivy-frontend-results.txt', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üîç Frontend Security Scan Results (Trivy)

            <details>
            <summary>üìä Click to view scan results</summary>

            \`\`\`
            ${trivyResults}
            \`\`\`

            </details>

            **Scan Details:**
            - üìÅ Directory: \`Frontend/\`
            - üîé Scanners: Vulnerabilities, Secrets, Misconfigurations
            - ‚ö†Ô∏è Severity: CRITICAL, HIGH
            `
            });

      # - name: Fail job if vulnerabilities found
      #   if: steps.trivy-frontend.outcome == 'failure'
      #   run: exit 1

  lint-and-scan-backend:
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: Trivy Scan Backend
        id: trivy-backend
        uses: aquasecurity/trivy-action@0.30.0
        continue-on-error: true
        with:
          scan-type: "fs"
          scan-ref: "Backend/"
          format: "table"
          scanners: "vuln,secret,misconfig"
          severity: "CRITICAL,HIGH"
          exit-code: 1
          output: "trivy-backend-results.txt"

      - name: Upload Trivy Results as Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-backend-scan
          path: trivy-backend-results.txt

      - name: Comment Trivy Results on PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const trivyResults = fs.readFileSync('trivy-backend-results.txt', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üîç Backend Security Scan Results (Trivy)

            <details>
            <summary>üìä Click to view scan results</summary>

            \`\`\`
            ${trivyResults}
            \`\`\`

            </details>

            **Scan Details:**
            - üìÅ Directory: \`Backend/\`
            - üîé Scanners: Vulnerabilities, Secrets, Misconfigurations
            - ‚ö†Ô∏è Severity: CRITICAL, HIGH
            `
            });

      # - name: Fail job if vulnerabilities found
      #   if: steps.trivy-backend.outcome == 'failure'
      #   run: exit 1
