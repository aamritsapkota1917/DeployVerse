name: Docker Scan Report on PR
permissions:
  pull-requests: write
  contents: read
  actions: read

on:
  pull_request:
    branches: ["main"]

jobs:
  fetch-trivy-results:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Find Latest Dev Branch Workflow Run
        id: find-run
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'docker-build-scan.yml', // Replace with your actual workflow filename
              branch: 'Dev',
              status: 'completed',
              per_page: 1
            });
            
            if (runs.workflow_runs.length === 0) {
              core.setFailed('No completed workflow runs found on Dev branch');
              return;
            }
            
            const runId = runs.workflow_runs[0].id;
            core.setOutput('run_id', runId);
            console.log(`Found workflow run: ${runId}`);

      - name: Download Backend Trivy Artifact
        uses: actions/download-artifact@v4
        with:
          name: trivy-backend-scan
          path: scans/backend
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.find-run.outputs.run_id }}
        continue-on-error: true

      - name: Download Frontend Trivy Artifact
        uses: actions/download-artifact@v4
        with:
          name: trivy-frontend-scan
          path: scans/frontend
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.find-run.outputs.run_id }}
        continue-on-error: true

      - name: Check if artifacts exist
        id: check-artifacts
        run: |
          BACKEND_EXISTS=false
          FRONTEND_EXISTS=false
          
          if [ -f "scans/backend/trivy-backend-results.txt" ]; then
            BACKEND_EXISTS=true
          fi
          
          if [ -f "scans/frontend/trivy-frontend-results.txt" ]; then
            FRONTEND_EXISTS=true
          fi
          
          echo "backend_exists=$BACKEND_EXISTS" >> $GITHUB_OUTPUT
          echo "frontend_exists=$FRONTEND_EXISTS" >> $GITHUB_OUTPUT

      - name: Parse scan results
        id: parse
        run: |
          # Just verify files exist, don't load into env vars
          if [ -f "scans/backend/trivy-backend-results.txt" ]; then
            echo "Backend scan results found"
          fi
          
          if [ -f "scans/frontend/trivy-frontend-results.txt" ]; then
            echo "Frontend scan results found"
          fi

      - name: Comment Trivy Results on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const runId = '${{ steps.find-run.outputs.run_id }}';
            
            let backend = "‚ö†Ô∏è No scan artifact found";
            let frontend = "‚ö†Ô∏è No scan artifact found";
            
            // Read files directly in JavaScript
            try {
              if (fs.existsSync('scans/backend/trivy-backend-results.txt')) {
                backend = fs.readFileSync('scans/backend/trivy-backend-results.txt', 'utf8');
              }
            } catch (error) {
              console.log('Could not read backend scan results:', error.message);
            }
            
            try {
              if (fs.existsSync('scans/frontend/trivy-frontend-results.txt')) {
                frontend = fs.readFileSync('scans/frontend/trivy-frontend-results.txt', 'utf8');
              }
            } catch (error) {
              console.log('Could not read frontend scan results:', error.message);
            }
            
            // Truncate from front if too large (keep the end/summary)
            const maxLength = 30000;
            if (backend.length > maxLength) {
              const truncated = backend.substring(backend.length - maxLength);
              backend = '... (showing last ' + maxLength + ' characters - see full report in artifacts)\n\n' + truncated;
            }
            if (frontend.length > maxLength) {
              const truncated = frontend.substring(frontend.length - maxLength);
              frontend = '... (showing last ' + maxLength + ' characters - see full report in artifacts)\n\n' + truncated;
            }
            
            const body = `## üõ°Ô∏è Docker Image Security Scan Report (Trivy)
            
            **Source:** Latest build from \`Dev\` branch (Run #${runId})
            
            ### üîπ Backend Docker Image
            <details>
            <summary>Click to view scan results</summary>
            
            \`\`\`
            ${backend}
            \`\`\`
            
            </details>
            
            ---
            
            ### üîπ Frontend Docker Image
            <details>
            <summary>Click to view scan results</summary>
            
            \`\`\`
            ${frontend}
            \`\`\`
            
            </details>
            
            ---
            
            **Scan Configuration:**
            - ‚úÖ Scans: Vulnerabilities, Secrets, Misconfigurations
            - ‚ö†Ô∏è Severity Levels: CRITICAL & HIGH only
            - üîó [View Full Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${runId})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body,
            });

      - name: Check for Critical Vulnerabilities
        if: steps.check-artifacts.outputs.backend_exists == 'true' || steps.check-artifacts.outputs.frontend_exists == 'true'
        run: |
          VULN_FOUND=false
          
          if [ -f "scans/backend/trivy-backend-results.txt" ]; then
            if grep -qiE "CRITICAL|HIGH" scans/backend/trivy-backend-results.txt; then
              echo "‚ùå CRITICAL or HIGH vulnerabilities found in Backend image!"
              VULN_FOUND=true
            fi
          fi
          
          if [ -f "scans/frontend/trivy-frontend-results.txt" ]; then
            if grep -qiE "CRITICAL|HIGH" scans/frontend/trivy-frontend-results.txt; then
              echo "‚ùå CRITICAL or HIGH vulnerabilities found in Frontend image!"
              VULN_FOUND=true
            fi
          fi
          
          # if [ "$VULN_FOUND" = true ]; then
          #   echo "‚ö†Ô∏è Blocking PR due to security vulnerabilities"
          #   exit 1
          # else
          #   echo "‚úÖ No critical vulnerabilities found"
          # fi